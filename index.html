<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Boo Bills">
  <title>Boo Bills</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    :root {
      --bg: #FAF7F2; --card: #FFFFFF; --text: #1A1A1A; --text-soft: #7A7067;
      --accent: #D4603A; --accent-soft: #F2DDD4;
      --green: #3A8A5C; --green-soft: #D4EDDF;
      --blue: #4A6FA5; --blue-soft: #D6E4F5;
      --purple: #7B5EA7; --purple-soft: #E8DFF5;
      --border: #EDE8E1;
      --shadow: 0 2px 12px rgba(0,0,0,0.06); --shadow-lg: 0 8px 32px rgba(0,0,0,0.10);
      --radius: 16px; --radius-sm: 12px;
      --font: 'DM Sans', 'Avenir', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-display: 'Playfair Display', Georgia, serif;
    }
    body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100vh; display: flex; justify-content: center; }
    .app {
      width: 100%; max-width: 420px; min-height: 100vh;
      padding: 24px 20px;
      padding-top: max(24px, env(safe-area-inset-top, 24px));
      padding-bottom: max(24px, env(safe-area-inset-bottom, 24px));
      display: flex; flex-direction: column; position: relative;
    }
    .bg-decor { position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 0; }
    .bg-decor::before { content: ''; position: absolute; top: -120px; right: -80px; width: 300px; height: 300px; border-radius: 50%; background: radial-gradient(circle, rgba(212,96,58,0.08) 0%, transparent 70%); }
    .bg-decor::after { content: ''; position: absolute; bottom: -80px; left: -60px; width: 250px; height: 250px; border-radius: 50%; background: radial-gradient(circle, rgba(58,138,92,0.06) 0%, transparent 70%); }

    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; position: relative; z-index: 1; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .header h1 { font-family: var(--font-display); font-size: 28px; font-weight: 700; letter-spacing: -0.02em; line-height: 1.2; }
    .header h1.small { font-size: 22px; }

    .btn-icon { background: var(--card); border: 1px solid var(--border); border-radius: 10px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text); box-shadow: var(--shadow); transition: all 0.15s ease; }
    .btn-icon:active { transform: scale(0.95); }
    .btn-icon.muted { color: var(--text-soft); }

    .btn-primary { background: var(--accent); color: white; border: none; border-radius: var(--radius-sm); padding: 18px; font-size: 16px; font-weight: 600; cursor: pointer; font-family: var(--font); width: 100%; transition: all 0.15s ease; }
    .btn-primary:active { transform: scale(0.98); }
    .btn-primary:disabled { opacity: 0.7; cursor: wait; }
    .btn-primary.green { background: var(--green); }
    .btn-primary.blue { background: var(--blue); }
    .btn-primary.purple { background: var(--purple); }

    .btn-secondary { display: flex; align-items: center; justify-content: center; gap: 6px; background: var(--card); color: var(--text); border: 1.5px solid var(--border); border-radius: var(--radius-sm); padding: 16px 20px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: var(--font); text-decoration: none; transition: all 0.15s ease; }
    .btn-secondary:active { transform: scale(0.98); }

    .expense-card { display: flex; align-items: center; gap: 16px; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px 20px; cursor: pointer; width: 100%; text-align: left; box-shadow: var(--shadow); transition: all 0.2s ease; }
    .expense-card:active { transform: scale(0.98); }
    @media (hover: hover) { .expense-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); } }
    .expense-card .icon-box { width: 48px; height: 48px; border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .expense-card .card-title { font-size: 16px; font-weight: 600; margin-bottom: 2px; letter-spacing: -0.01em; }
    .expense-card .card-sub { font-size: 13px; color: var(--text-soft); line-height: 1.3; }
    .expense-card .chevron { color: var(--text-soft); opacity: 0.4; flex-shrink: 0; }

    .split-option { display: flex; align-items: center; gap: 14px; background: var(--card); border: 1.5px solid var(--border); border-radius: var(--radius-sm); padding: 16px 18px; cursor: pointer; width: 100%; text-align: left; transition: all 0.2s ease; }
    .split-option:active { transform: scale(0.98); }
    .split-option .radio { width: 22px; height: 22px; border-radius: 50%; border: 2px solid var(--border); flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
    .split-option .opt-title { font-size: 15px; font-weight: 600; }
    .split-option .opt-sub { font-size: 12px; color: var(--text-soft); margin-top: 1px; }

    .paid-by-section { margin-bottom: 24px; }
    .paid-by-label { font-size: 13px; font-weight: 600; color: var(--text-soft); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 10px; }
    .paid-by-toggle { display: flex; gap: 8px; }
    .paid-by-btn { flex: 1; padding: 14px 16px; border-radius: var(--radius-sm); border: 1.5px solid var(--border); background: var(--card); font-family: var(--font); font-size: 15px; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.2s ease; color: var(--text); }
    .paid-by-btn:active { transform: scale(0.98); }
    .paid-by-btn.selected { background: var(--accent-soft); border-color: var(--accent); color: var(--accent); }

    .quick-card { display: flex; align-items: center; gap: 14px; border: none; border-radius: var(--radius); padding: 18px 20px; cursor: pointer; width: 100%; text-align: left; transition: all 0.2s ease; color: white; }
    .quick-card:active { transform: scale(0.98); }
    @media (hover: hover) { .quick-card:hover { transform: translateY(-2px); } }
    .quick-card .icon-box { width: 44px; height: 44px; border-radius: 12px; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .quick-card .card-title { font-size: 16px; font-weight: 600; margin-bottom: 2px; }
    .quick-card .card-sub { font-size: 12px; opacity: 0.85; }
    .quick-costco { background: linear-gradient(135deg, var(--blue), #5A82B8); box-shadow: 0 4px 16px rgba(74,111,165,0.25); }
    .quick-cdy { background: linear-gradient(135deg, var(--accent), #E07A56); box-shadow: 0 4px 16px rgba(212,96,58,0.25); }

    /* ═══ BALANCE CARD ═══ */
    .balance-card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px;
      box-shadow: var(--shadow); margin-bottom: 24px;
      animation: fadeIn 0.3s ease;
    }
    .balance-card .balance-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
    }
    .balance-card .balance-title {
      font-size: 11px; font-weight: 600; color: var(--text-soft);
      text-transform: uppercase; letter-spacing: 0.08em;
    }
    .balance-card .balance-refresh {
      background: none; border: none; color: var(--text-soft); cursor: pointer;
      font-size: 12px; font-family: var(--font); padding: 4px 8px;
      border-radius: 6px; transition: all 0.15s;
    }
    .balance-card .balance-refresh:active { background: var(--border); }
    .balance-card .balance-rows { display: flex; flex-direction: column; gap: 8px; }
    .balance-card .balance-row {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 14px;
    }
    .balance-card .balance-row .blabel { color: var(--text-soft); }
    .balance-card .balance-row .bval { font-weight: 600; font-size: 15px; }
    .balance-card .balance-divider { height: 1px; background: var(--border); margin: 8px 0; }
    .balance-card .balance-net {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 16px; border-radius: var(--radius-sm); margin-top: 4px;
    }
    .balance-net .net-label { font-weight: 700; font-size: 14px; }
    .balance-net .net-val { font-weight: 700; font-size: 20px; font-family: var(--font-display); }
    .balance-net.positive { background: #FFF3E0; color: var(--accent); }
    .balance-net.negative { background: var(--green-soft); color: var(--green); }
    .balance-net.zero { background: #F5F5F5; color: var(--text-soft); }
    .balance-loading {
      text-align: center; padding: 16px; color: var(--text-soft); font-size: 13px;
    }
    .balance-loading .dots::after {
      content: ''; animation: dots 1.5s steps(4, end) infinite;
    }
    @keyframes dots { 0% { content: ''; } 25% { content: '.'; } 50% { content: '..'; } 75% { content: '...'; } }

    .amount-area { text-align: center; }
    .amount-label { font-size: 13px; font-weight: 600; color: var(--text-soft); text-transform: uppercase; letter-spacing: 0.08em; }
    .amount-wrap { position: relative; margin-top: 12px; display: inline-block; }
    .dollar-sign { position: absolute; left: -28px; top: 50%; transform: translateY(-50%); font-size: 42px; font-weight: 300; color: var(--text-soft); opacity: 0.5; font-family: var(--font-display); }
    .amount-input { width: 200px; text-align: center; font-size: 48px; font-weight: 300; font-family: var(--font-display); border: none; border-bottom: 2px solid var(--border); background: transparent; outline: none; padding: 8px 0; color: var(--text); transition: border-color 0.2s; }
    .amount-input:focus { border-bottom-color: var(--accent); }
    .amount-input.green:focus { border-bottom-color: var(--green); }
    .amount-input.blue:focus { border-bottom-color: var(--blue); }
    .amount-input.purple:focus { border-bottom-color: var(--purple); }

    .desc-input { width: 100%; max-width: 280px; text-align: center; padding: 12px 16px; font-size: 15px; border: 1.5px solid var(--border); border-radius: var(--radius-sm); background: var(--card); font-family: var(--font); outline: none; transition: border-color 0.2s; }
    .desc-input:focus { border-color: var(--accent); }
    .desc-input.green:focus { border-color: var(--green); }
    .desc-input.blue:focus { border-color: var(--blue); }
    .desc-input.purple:focus { border-color: var(--purple); }

    .preview-split { display: flex; justify-content: center; gap: 24px; padding: 12px 0; animation: fadeIn 0.3s ease; }
    .preview-split .person { text-align: center; }
    .preview-split .label { font-size: 12px; color: var(--text-soft); margin-bottom: 2px; }
    .preview-split .value { font-size: 17px; font-weight: 600; }
    .preview-split .divider { width: 1px; background: var(--border); }

    .preview-box { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px 18px; max-width: 300px; margin: 0 auto; width: 100%; animation: fadeIn 0.3s ease; }
    .preview-box .preview-title { font-size: 12px; color: var(--text-soft); margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    .preview-box .row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }
    .preview-box .row:last-child { margin-bottom: 0; }
    .preview-box .row .rlabel { color: var(--text-soft); }
    .preview-box .row .rval { font-weight: 600; }

    .tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .tag-accent { background: var(--accent-soft); color: var(--accent); }
    .tag-blue { background: var(--blue-soft); color: var(--blue); }
    .tag-green { background: var(--green-soft); color: var(--green); }
    .tag-purple { background: var(--purple-soft); color: var(--purple); }

    .success-icon { width: 72px; height: 72px; border-radius: 50%; background: var(--green-soft); color: var(--green); display: flex; align-items: center; justify-content: center; margin-bottom: 24px; animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .success-title { font-family: var(--font-display); font-size: 24px; font-weight: 700; margin-bottom: 8px; }
    .success-msg { color: var(--text-soft); font-size: 15px; margin-bottom: 32px; line-height: 1.5; }

    .settings-label { font-size: 13px; font-weight: 600; color: var(--text-soft); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; display: block; }
    .settings-input { width: 100%; padding: 14px 16px; font-size: 14px; border: 1.5px solid var(--border); border-radius: var(--radius-sm); background: var(--card); font-family: var(--font); outline: none; transition: border-color 0.2s; }
    .settings-input:focus { border-color: var(--accent); }
    .settings-hint { font-size: 12px; color: var(--text-soft); margin-top: 6px; line-height: 1.4; }

    .setup-box { background: var(--blue-soft); border-radius: var(--radius-sm); padding: 16px; margin-top: 8px; }
    .setup-box .setup-title { font-size: 13px; font-weight: 600; color: var(--blue); margin-bottom: 8px; }
    .setup-box ol { font-size: 12px; color: var(--blue); margin: 0; padding-left: 16px; line-height: 1.6; }

    .warning-box { background: #FFF3E0; border-radius: var(--radius-sm); padding: 14px 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; border: 1px solid #FFE0B2; }
    .warning-box p { font-size: 13px; color: #E65100; line-height: 1.4; }

    .error-msg { color: #D44; font-size: 13px; text-align: center; }
    .section-label { font-size: 11px; font-weight: 600; color: var(--text-soft); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 10px; }

    .sheet-link { display: flex; align-items: center; justify-content: center; gap: 8px; color: var(--text-soft); font-size: 13px; font-weight: 500; text-decoration: none; padding: 12px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--card); }

    .spacer { flex: 1; }
    .gap-10 { display: flex; flex-direction: column; gap: 10px; }
    .gap-20 { display: flex; flex-direction: column; gap: 20px; }
    .mb-20 { margin-bottom: 20px; }
    .mb-24 { margin-bottom: 24px; }
    .mt-8 { margin-top: 8px; }
    .center { text-align: center; }
    .vcenter { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; }

    .screen { display: none; flex-direction: column; flex: 1; position: relative; z-index: 1; }
    .screen.active { display: flex; }

    /* ═══ CUSTOM SPLIT ═══ */
    .custom-split-row { display: flex; gap: 12px; align-items: center; margin-top: 12px; }
    .custom-split-input-wrap { flex: 1; text-align: center; }
    .custom-split-input-wrap label { font-size: 12px; color: var(--text-soft); display: block; margin-bottom: 4px; font-weight: 600; }
    .custom-split-input { width: 100%; text-align: center; padding: 10px 8px; font-size: 16px; font-weight: 600; border: 1.5px solid var(--border); border-radius: var(--radius-sm); background: var(--card); font-family: var(--font); outline: none; transition: border-color 0.2s; }
    .custom-split-input:focus { border-color: var(--accent); }

    /* ═══ SUMMARY SCREEN ═══ */
    .summary-sheet-link { display: flex; align-items: center; justify-content: center; gap: 8px; color: var(--accent); font-size: 14px; font-weight: 600; text-decoration: none; padding: 12px 16px; border-radius: var(--radius-sm); border: 1.5px solid var(--accent); background: var(--accent-soft); margin-bottom: 20px; transition: all 0.15s ease; }
    .summary-sheet-link:active { transform: scale(0.98); }
    .expense-list { display: flex; flex-direction: column; gap: 8px; }
    .expense-item { display: flex; align-items: center; gap: 14px; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px 16px; box-shadow: var(--shadow); }
    .expense-item .ei-amount { font-family: var(--font-display); font-size: 17px; font-weight: 600; white-space: nowrap; }
    .expense-item .ei-details { flex: 1; min-width: 0; }
    .expense-item .ei-desc { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .expense-item .ei-meta { font-size: 12px; color: var(--text-soft); margin-top: 2px; }
    .expense-item .ei-split-tag { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; white-space: nowrap; }
    .summary-empty { text-align: center; padding: 40px 20px; color: var(--text-soft); }
    .summary-empty .empty-icon { font-size: 40px; margin-bottom: 12px; }
    .summary-empty p { font-size: 14px; line-height: 1.5; }

    /* ═══ SWIPE HINT ═══ */
    .swipe-hint { display: flex; align-items: center; justify-content: center; gap: 6px; color: var(--text-soft); font-size: 12px; margin-top: 16px; opacity: 0.6; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  </style>
</head>
<body>
  <div class="bg-decor"></div>
  <div class="app">

    <!-- ═══ HOME ═══ -->
    <div class="screen active" id="screen-home">
      <div class="header">
        <div class="header-left"><h1>Boo Bills</h1></div>
        <button class="btn-icon muted" onclick="showScreen('settings')" aria-label="Settings">
          <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.32 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        </button>
      </div>
      <div id="home-warning"></div>
      <div class="gap-10 mb-24">
        <button class="expense-card" onclick="showScreen('boobills')">
          <div class="icon-box" style="background:var(--accent-soft);color:var(--accent)"><svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></div>
          <div style="flex:1"><div class="card-title">Boo Bills</div><div class="card-sub">Joint expenses — Connor & Spencer</div></div>
          <div class="chevron"><svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg></div>
        </button>
        <button class="expense-card" onclick="showScreen('mom')">
          <div class="icon-box" style="background:var(--green-soft);color:var(--green)"><svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="9"/><path stroke-linecap="round" d="M9 10h.01M15 10h.01M8 14s1.5 2 4 2 4-2 4-2"/></svg></div>
          <div style="flex:1"><div class="card-title">Mom Bills</div><div class="card-sub">Expenses with Mom</div></div>
          <div class="chevron"><svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg></div>
        </button>
      </div>
      <div class="mb-20">
        <div class="section-label">Quick Actions</div>
        <div class="gap-10">
          <button class="quick-card quick-costco" onclick="startAmount('costco')">
            <div class="icon-box"><svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-8 2a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/></svg></div>
            <div><div class="card-title">Costco Run</div><div class="card-sub">Logs to Mom + 80/20 Boo Bills</div></div>
          </button>
          <button class="quick-card quick-cdy" onclick="startAmount('cdy')">
            <div class="icon-box"><svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0zM12 14a7 7 0 0 0-7 7h14a7 7 0 0 0-7-7z"/></svg></div>
            <div><div class="card-title">CDY Personal Charge</div><div class="card-sub">Paid by Connor · 80/20 split</div></div>
          </button>
        </div>
      </div>
      <div id="home-sheet-link"></div>
      <div class="swipe-hint" onclick="showScreen('summary')" style="cursor:pointer">
        <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
        Expense summary →
      </div>
    </div>

    <!-- ═══ EXPENSE SUMMARY ═══ -->
    <div class="screen" id="screen-summary">
      <div class="header">
        <div class="header-left">
          <button class="btn-icon" onclick="showScreen('home')"><svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg></button>
          <h1 class="small">Boo Bills Summary</h1>
        </div>
      </div>
      <div id="summary-sheet-link-area"></div>
      <div id="summary-balance"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div class="section-label" style="margin-bottom:0">Recent Expenses</div>
        <button class="balance-refresh" onclick="refreshSummary()" style="font-size:12px;padding:4px 8px;border-radius:6px;border:none;background:none;color:var(--text-soft);cursor:pointer">↻ Refresh</button>
      </div>
      <div id="summary-expenses">
        <div class="balance-loading">Loading expenses<span class="dots"></span></div>
      </div>
    </div>

    <!-- ═══ BOO BILLS ═══ -->
    <div class="screen" id="screen-boobills">
      <div class="header">
        <div class="header-left">
          <button class="btn-icon" onclick="showScreen('home')"><svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg></button>
          <h1 class="small">Boo Bills</h1>
        </div>
      </div>
      <div id="boo-balance"></div>
      <div class="paid-by-section">
        <div class="paid-by-label">Paid by</div>
        <div class="paid-by-toggle">
          <button class="paid-by-btn selected" id="paidby-connor" onclick="selectPaidBy('Connor')">Connor</button>
          <button class="paid-by-btn" id="paidby-spencer" onclick="selectPaidBy('Spencer')">Spencer</button>
        </div>
      </div>
      <div class="paid-by-label" style="margin-bottom:10px">Split type</div>
      <div class="gap-10">
        <button class="split-option" onclick="startAmount('boobills','80/20')">
          <div class="radio"></div>
          <div><div class="opt-title">80 / 20 Split</div><div class="opt-sub">Connor 80% · Spencer 20%</div></div>
        </button>
        <button class="split-option" onclick="startAmount('boobills','Connor owes Spencer')">
          <div class="radio"></div>
          <div><div class="opt-title">Connor owes Spencer 100%</div><div class="opt-sub">Connor pays the full amount</div></div>
        </button>
        <button class="split-option" onclick="startAmount('boobills','Spencer owes Connor')">
          <div class="radio"></div>
          <div><div class="opt-title">Spencer owes Connor 100%</div><div class="opt-sub">Spencer pays the full amount</div></div>
        </button>
        <button class="split-option" onclick="startAmount('boobills','50/50')">
          <div class="radio"></div>
          <div><div class="opt-title">50 / 50 Split</div><div class="opt-sub">Connor 50% · Spencer 50%</div></div>
        </button>
        <button class="split-option" onclick="startCustomSplit()">
          <div class="radio"></div>
          <div><div class="opt-title">Custom Split</div><div class="opt-sub">Set your own percentages</div></div>
        </button>
        <div id="custom-split-area" style="display:none">
          <div class="custom-split-row">
            <div class="custom-split-input-wrap">
              <label>Connor %</label>
              <input type="number" inputmode="decimal" id="custom-connor-pct" class="custom-split-input" value="50" min="0" max="100" oninput="syncCustomSplit('connor')">
            </div>
            <div class="custom-split-input-wrap">
              <label>Spencer %</label>
              <input type="number" inputmode="decimal" id="custom-spencer-pct" class="custom-split-input" value="50" min="0" max="100" oninput="syncCustomSplit('spencer')">
            </div>
          </div>
          <button class="btn-primary mt-8" onclick="confirmCustomSplit()">Use This Split</button>
        </div>
      </div>
    </div>

    <!-- ═══ MOM BILLS ═══ -->
    <div class="screen" id="screen-mom">
      <div class="header">
        <div class="header-left">
          <button class="btn-icon" onclick="showScreen('home')"><svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg></button>
          <h1 class="small">Mom Bills</h1>
        </div>
      </div>
      <div id="mom-balance"></div>
      <p style="color:var(--text-soft);font-size:14px;margin:0 0 20px 0;line-height:1.5">Who owes whom?</p>
      <div class="gap-10">
        <button class="expense-card" onclick="startAmount('mom-owed')">
          <div class="icon-box" style="background:var(--green-soft);color:var(--green)"><svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14M5 12l7 7 7-7"/></svg></div>
          <div style="flex:1"><div class="card-title">Connor Owes Mom</div><div class="card-sub">Log money owed to Mom</div></div>
          <div class="chevron"><svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg></div>
        </button>
        <button class="expense-card" onclick="startAmount('mom-owes')">
          <div class="icon-box" style="background:var(--purple-soft);color:var(--purple)"><svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5M5 12l7-7 7 7"/></svg></div>
          <div style="flex:1"><div class="card-title">Mom Owes Connor</div><div class="card-sub">Log money Mom owes back</div></div>
          <div class="chevron"><svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg></div>
        </button>
      </div>
    </div>

    <!-- ═══ AMOUNT ═══ -->
    <div class="screen" id="screen-amount">
      <div class="header">
        <div class="header-left">
          <button class="btn-icon" onclick="goBackFromAmount()"><svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg></button>
          <h1 class="small" id="amount-title"></h1>
        </div>
      </div>
      <div id="amount-context" style="margin-bottom:8px"></div>
      <div class="spacer"></div>
      <div class="gap-20 center" style="margin-bottom:32px">
        <div class="amount-area">
          <div class="amount-label">Amount</div>
          <div class="amount-wrap">
            <span class="dollar-sign">$</span>
            <input type="number" inputmode="decimal" id="amount-input" class="amount-input" placeholder="0.00" oninput="updatePreview()" onkeydown="if(event.key==='Enter')submitExpense()">
          </div>
        </div>
        <div class="center">
          <input type="text" id="desc-input" class="desc-input" placeholder="Notes (optional)" onkeydown="if(event.key==='Enter')submitExpense()">
        </div>
        <div id="preview-area"></div>
        <div id="error-area"></div>
      </div>
      <div class="spacer"></div>
      <button class="btn-primary" id="submit-btn" onclick="submitExpense()">Log Expense</button>
    </div>

    <!-- ═══ SUCCESS ═══ -->
    <div class="screen" id="screen-success">
      <div class="vcenter center">
        <div class="success-icon"><svg width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg></div>
        <div class="success-title">Logged!</div>
        <div class="success-msg" id="success-msg"></div>
        <div style="display:flex;gap:12px;width:100%">
          <button class="btn-primary" onclick="resetApp()" style="flex:1">Done</button>
          <a class="btn-secondary" id="success-sheet-link" href="#" target="_blank" rel="noopener noreferrer" style="display:none">
            Sheet <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/></svg>
          </a>
        </div>
      </div>
    </div>

    <!-- ═══ SETTINGS ═══ -->
    <div class="screen" id="screen-settings">
      <div class="header">
        <div class="header-left">
          <button class="btn-icon" onclick="showScreen('home')"><svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg></button>
          <h1 class="small">Settings</h1>
        </div>
      </div>
      <div class="gap-20">
        <div>
          <label class="settings-label">Google Apps Script URL</label>
          <input type="url" id="settings-script-url" class="settings-input" placeholder="https://script.google.com/macros/s/...">
          <p class="settings-hint">Deploy the Apps Script as a web app and paste the URL here. Must end in /exec</p>
        </div>
        <div>
          <label class="settings-label">Google Sheet URL (optional)</label>
          <input type="url" id="settings-sheet-url" class="settings-input" placeholder="https://docs.google.com/spreadsheets/d/...">
          <p class="settings-hint">Link to your Google Sheet for quick access.</p>
        </div>
        <button class="btn-primary" onclick="saveSettings()">Save Settings</button>
        <div class="setup-box mt-8">
          <div class="setup-title">Setup Instructions</div>
          <ol>
            <li>Create a Google Sheet with two tabs: <strong>"Boo Bills"</strong> and <strong>"Mom"</strong></li>
            <li>Extensions → Apps Script → paste the backend code</li>
            <li>Deploy → New Deployment → Web App → Anyone</li>
            <li>Copy the URL (ends in <strong>/exec</strong>) and paste above</li>
            <li>Headers & summary formulas are auto-created!</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <script>
    var expenseType = null, splitType = null, paidBy = 'Connor';
    var scriptUrl = '', sheetUrl = '';
    var cachedBalances = null;
    var customConnorPct = 50, customSpencerPct = 50;

    function init() {
      try { scriptUrl = localStorage.getItem('boobills_script_url') || ''; sheetUrl = localStorage.getItem('boobills_sheet_url') || ''; } catch(e) {}
      updateHomeWarning(); updateHomeSheetLink();
      initSwipeGesture();
    }

    // ═══ SWIPE GESTURE ═══
    function initSwipeGesture() {
      var homeScreen = document.getElementById('screen-home');
      var touchStartX = 0, touchStartY = 0, swiping = false;
      homeScreen.addEventListener('touchstart', function(e) {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        swiping = true;
      }, { passive: true });
      homeScreen.addEventListener('touchmove', function(e) {
        // allow natural scroll
      }, { passive: true });
      homeScreen.addEventListener('touchend', function(e) {
        if (!swiping) return;
        swiping = false;
        var dx = e.changedTouches[0].clientX - touchStartX;
        var dy = e.changedTouches[0].clientY - touchStartY;
        // Swipe right: dx > 80px and more horizontal than vertical
        if (dx > 80 && Math.abs(dy) < Math.abs(dx) * 0.7) {
          showScreen('summary');
        }
      }, { passive: true });
    }

    // ═══ CUSTOM SPLIT ═══
    function startCustomSplit() {
      var area = document.getElementById('custom-split-area');
      area.style.display = area.style.display === 'none' ? 'block' : 'none';
    }
    function syncCustomSplit(source) {
      var connorEl = document.getElementById('custom-connor-pct');
      var spencerEl = document.getElementById('custom-spencer-pct');
      if (source === 'connor') {
        var v = parseFloat(connorEl.value) || 0;
        if (v > 100) { v = 100; connorEl.value = 100; }
        spencerEl.value = Math.max(0, +(100 - v).toFixed(2));
      } else {
        var v = parseFloat(spencerEl.value) || 0;
        if (v > 100) { v = 100; spencerEl.value = 100; }
        connorEl.value = Math.max(0, +(100 - v).toFixed(2));
      }
    }
    function confirmCustomSplit() {
      customConnorPct = parseFloat(document.getElementById('custom-connor-pct').value) || 0;
      customSpencerPct = parseFloat(document.getElementById('custom-spencer-pct').value) || 0;
      if (customConnorPct + customSpencerPct !== 100) {
        customSpencerPct = 100 - customConnorPct;
      }
      document.getElementById('custom-split-area').style.display = 'none';
      var label = Math.round(customConnorPct) + '/' + Math.round(customSpencerPct);
      startAmount('boobills', 'Custom ' + label);
    }

    // ═══ BALANCE FETCHING (JSONP) ═══
    function fetchBalances(callback) {
      if (!scriptUrl) { callback(null); return; }
      var cbName = 'bbcb_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
      var timeout = setTimeout(function() {
        delete window[cbName];
        callback(null);
      }, 8000);

      window[cbName] = function(data) {
        clearTimeout(timeout);
        delete window[cbName];
        cachedBalances = data;
        callback(data);
      };

      var s = document.createElement('script');
      s.src = scriptUrl + '?action=balances&callback=' + cbName;
      s.onerror = function() { clearTimeout(timeout); delete window[cbName]; callback(null); };
      document.head.appendChild(s);
      // Clean up script tag
      setTimeout(function() { try { document.head.removeChild(s); } catch(e) {} }, 10000);
    }

    function renderBooBalance(container, data) {
      if (!data || !data.boo) {
        container.innerHTML = '<div class="balance-card"><div class="balance-loading">Loading balance<span class="dots"></span></div></div>';
        return;
      }
      var b = data.boo;
      var netClass = b.net > 0 ? 'positive' : (b.net < 0 ? 'negative' : 'zero');
      var netLabel = b.net > 0 ? 'Spencer owes Connor' : (b.net < 0 ? 'Connor owes Spencer' : 'All settled up!');
      var netVal = Math.abs(b.net);

      container.innerHTML =
        '<div class="balance-card">' +
          '<div class="balance-header"><span class="balance-title">Current Balance</span><button class="balance-refresh" onclick="refreshBooBalance()">↻ Refresh</button></div>' +
          '<div class="balance-rows">' +
            '<div class="balance-row"><span class="blabel">Spencer owes Connor</span><span class="bval">' + fmt(b.spencerOwesConnor) + '</span></div>' +
            '<div class="balance-row"><span class="blabel">Connor owes Spencer</span><span class="bval">' + fmt(b.connorOwesSpencer) + '</span></div>' +
          '</div>' +
          '<div class="balance-divider"></div>' +
          '<div class="balance-net ' + netClass + '">' +
            '<span class="net-label">' + netLabel + '</span>' +
            '<span class="net-val">' + (b.net === 0 ? '✓' : fmt(netVal)) + '</span>' +
          '</div>' +
        '</div>';
    }

    function renderMomBalance(container, data) {
      if (!data || !data.mom) {
        container.innerHTML = '<div class="balance-card"><div class="balance-loading">Loading balance<span class="dots"></span></div></div>';
        return;
      }
      var m = data.mom;
      var netClass = m.net > 0 ? 'positive' : (m.net < 0 ? 'negative' : 'zero');
      var netLabel = m.net > 0 ? 'Connor owes Mom' : (m.net < 0 ? 'Mom owes Connor' : 'All settled up!');
      var netVal = Math.abs(m.net);

      container.innerHTML =
        '<div class="balance-card">' +
          '<div class="balance-header"><span class="balance-title">Current Balance</span><button class="balance-refresh" onclick="refreshMomBalance()">↻ Refresh</button></div>' +
          '<div class="balance-rows">' +
            '<div class="balance-row"><span class="blabel">Connor owes Mom</span><span class="bval">' + fmt(m.connorOwesMom) + '</span></div>' +
            '<div class="balance-row"><span class="blabel">Mom owes Connor</span><span class="bval">' + fmt(m.momOwesConnor) + '</span></div>' +
          '</div>' +
          '<div class="balance-divider"></div>' +
          '<div class="balance-net ' + netClass + '">' +
            '<span class="net-label">' + netLabel + '</span>' +
            '<span class="net-val">' + (m.net === 0 ? '✓' : fmt(netVal)) + '</span>' +
          '</div>' +
        '</div>';
    }

    function refreshBooBalance() {
      var el = document.getElementById('boo-balance');
      el.innerHTML = '<div class="balance-card"><div class="balance-loading">Loading balance<span class="dots"></span></div></div>';
      fetchBalances(function(data) { renderBooBalance(el, data); });
    }

    function refreshMomBalance() {
      var el = document.getElementById('mom-balance');
      el.innerHTML = '<div class="balance-card"><div class="balance-loading">Loading balance<span class="dots"></span></div></div>';
      fetchBalances(function(data) { renderMomBalance(el, data); });
    }

    // ═══ NAVIGATION ═══
    function showScreen(name) {
      document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
      document.getElementById('screen-' + name).classList.add('active');
      if (name === 'settings') {
        document.getElementById('settings-script-url').value = scriptUrl;
        document.getElementById('settings-sheet-url').value = sheetUrl;
      }
      if (name === 'home') { updateHomeWarning(); updateHomeSheetLink(); }
      if (name === 'boobills') {
        paidBy = 'Connor'; updatePaidByUI();
        document.getElementById('custom-split-area').style.display = 'none';
        var el = document.getElementById('boo-balance');
        if (cachedBalances) { renderBooBalance(el, cachedBalances); }
        else if (scriptUrl) {
          el.innerHTML = '<div class="balance-card"><div class="balance-loading">Loading balance<span class="dots"></span></div></div>';
          fetchBalances(function(data) { renderBooBalance(el, data); });
        } else { el.innerHTML = ''; }
      }
      if (name === 'mom') {
        var el = document.getElementById('mom-balance');
        if (cachedBalances) { renderMomBalance(el, cachedBalances); }
        else if (scriptUrl) {
          el.innerHTML = '<div class="balance-card"><div class="balance-loading">Loading balance<span class="dots"></span></div></div>';
          fetchBalances(function(data) { renderMomBalance(el, data); });
        } else { el.innerHTML = ''; }
      }
      if (name === 'summary') {
        updateSummarySheetLink();
        var balEl = document.getElementById('summary-balance');
        if (cachedBalances) { renderBooBalance(balEl, cachedBalances); }
        else if (scriptUrl) {
          balEl.innerHTML = '<div class="balance-card"><div class="balance-loading">Loading balance<span class="dots"></span></div></div>';
          fetchBalances(function(data) { renderBooBalance(balEl, data); });
        } else { balEl.innerHTML = ''; }
        fetchExpenses();
      }
    }

    function selectPaidBy(who) { paidBy = who; updatePaidByUI(); }
    function updatePaidByUI() {
      document.getElementById('paidby-connor').className = 'paid-by-btn' + (paidBy === 'Connor' ? ' selected' : '');
      document.getElementById('paidby-spencer').className = 'paid-by-btn' + (paidBy === 'Spencer' ? ' selected' : '');
    }

    function startAmount(type, split) {
      expenseType = type; splitType = split || null;
      if (type === 'costco' || type === 'cdy') { paidBy = 'Connor'; splitType = '80/20'; }
      showScreen('amount');

      var titles = { 'boobills': 'Boo Bills', 'mom-owed': 'Connor Owes Mom', 'mom-owes': 'Mom Owes Connor', 'costco': 'Costco Expense', 'cdy': 'CDY Personal Charge' };
      document.getElementById('amount-title').textContent = titles[type];

      var ctx = document.getElementById('amount-context');
      if (type === 'boobills') ctx.innerHTML = '<div style="display:flex;gap:8px;flex-wrap:wrap"><span class="tag tag-accent">Paid by ' + paidBy + '</span><span class="tag tag-accent">' + split + '</span></div>';
      else if (type === 'costco') ctx.innerHTML = '<div style="display:flex;gap:8px;flex-wrap:wrap"><span class="tag tag-blue">Mom owed 100%</span><span class="tag tag-blue">+ 80/20 Boo Bills</span></div>';
      else if (type === 'cdy') ctx.innerHTML = '<div style="display:flex;gap:8px;flex-wrap:wrap"><span class="tag tag-accent">Paid by Connor</span><span class="tag tag-accent">80/20 split</span></div>';
      else if (type === 'mom-owed') ctx.innerHTML = '<div style="display:flex;gap:8px"><span class="tag tag-green">Connor → Mom</span></div>';
      else if (type === 'mom-owes') ctx.innerHTML = '<div style="display:flex;gap:8px"><span class="tag tag-purple">Mom → Connor</span></div>';
      else ctx.innerHTML = '';

      var colorMap = { 'boobills': '', 'mom-owed': 'green', 'mom-owes': 'purple', 'costco': 'blue', 'cdy': '' };
      var c = colorMap[type];
      document.getElementById('amount-input').className = 'amount-input' + (c ? ' ' + c : '');
      document.getElementById('desc-input').className = 'desc-input' + (c ? ' ' + c : '');
      document.getElementById('submit-btn').className = 'btn-primary' + (c ? ' ' + c : '');

      document.getElementById('amount-input').value = '';
      document.getElementById('desc-input').value = (type === 'costco') ? 'Costco' : '';
      document.getElementById('preview-area').innerHTML = '';
      document.getElementById('error-area').innerHTML = '';
      setTimeout(function() { document.getElementById('amount-input').focus(); }, 200);
    }

    function goBackFromAmount() {
      if (expenseType === 'boobills') showScreen('boobills');
      else if (expenseType === 'mom-owed' || expenseType === 'mom-owes') showScreen('mom');
      else showScreen('home');
    }

    function resetApp() {
      expenseType = null; splitType = null; paidBy = 'Connor';
      cachedBalances = null; // force re-fetch next time
      showScreen('home');
    }

    function updatePreview() {
      var val = parseFloat(document.getElementById('amount-input').value);
      var area = document.getElementById('preview-area');
      if (!val || val <= 0) { area.innerHTML = ''; return; }
      if ((expenseType === 'boobills' || expenseType === 'cdy') && splitType === '80/20') {
        area.innerHTML = '<div class="preview-split"><div class="person"><div class="label">Connor</div><div class="value">' + fmt(val * 0.8) + '</div></div><div class="divider"></div><div class="person"><div class="label">Spencer</div><div class="value">' + fmt(val * 0.2) + '</div></div></div>';
      } else if ((expenseType === 'boobills') && splitType === '50/50') {
        area.innerHTML = '<div class="preview-split"><div class="person"><div class="label">Connor</div><div class="value">' + fmt(val * 0.5) + '</div></div><div class="divider"></div><div class="person"><div class="label">Spencer</div><div class="value">' + fmt(val * 0.5) + '</div></div></div>';
      } else if ((expenseType === 'boobills') && splitType && splitType.indexOf('Custom') === 0) {
        var cPct = customConnorPct / 100, sPct = customSpencerPct / 100;
        area.innerHTML = '<div class="preview-split"><div class="person"><div class="label">Connor (' + Math.round(customConnorPct) + '%)</div><div class="value">' + fmt(val * cPct) + '</div></div><div class="divider"></div><div class="person"><div class="label">Spencer (' + Math.round(customSpencerPct) + '%)</div><div class="value">' + fmt(val * sPct) + '</div></div></div>';
      } else if (expenseType === 'costco') {
        area.innerHTML = '<div class="preview-box"><div class="preview-title">This will log:</div><div class="row"><span class="rlabel">Mom owed</span><span class="rval">' + fmt(val) + '</span></div><div class="row"><span class="rlabel">Connor (80%)</span><span class="rval">' + fmt(val * 0.8) + '</span></div><div class="row"><span class="rlabel">Spencer (20%)</span><span class="rval">' + fmt(val * 0.2) + '</span></div></div>';
      } else { area.innerHTML = ''; }
    }

    function submitExpense() {
      var val = parseFloat(document.getElementById('amount-input').value);
      var desc = document.getElementById('desc-input').value.trim();
      var errorArea = document.getElementById('error-area');
      if (!val || val <= 0) { errorArea.innerHTML = '<p class="error-msg">Please enter a valid amount</p>'; return; }
      if (!scriptUrl) { errorArea.innerHTML = '<p class="error-msg">Set your Google Apps Script URL in settings first</p>'; return; }

      var btn = document.getElementById('submit-btn');
      btn.disabled = true; btn.textContent = 'Logging...'; errorArea.innerHTML = '';

      var entries = [], now = new Date().toLocaleDateString('en-US');

      if (expenseType === 'costco') {
        entries.push({ sheet: 'Mom', date: now, description: desc || 'Costco', amount: val, type: 'Owed to Mom' });
        entries.push({ sheet: 'Boo Bills', date: now, description: desc || 'Costco', amount: val, paidBy: 'Connor', splitType: '80/20', connorOwes: +(val * 0.8).toFixed(2), spencerOwes: +(val * 0.2).toFixed(2) });
      } else if (expenseType === 'cdy') {
        entries.push({ sheet: 'Boo Bills', date: now, description: desc || 'CDY Personal', amount: val, paidBy: 'Connor', splitType: '80/20', connorOwes: +(val * 0.8).toFixed(2), spencerOwes: +(val * 0.2).toFixed(2) });
      } else if (expenseType === 'boobills') {
        var entry = { sheet: 'Boo Bills', date: now, description: desc || 'Expense', amount: val, paidBy: paidBy, splitType: splitType };
        if (splitType === '80/20') { entry.connorOwes = +(val * 0.8).toFixed(2); entry.spencerOwes = +(val * 0.2).toFixed(2); }
        else if (splitType === '50/50') { entry.connorOwes = +(val * 0.5).toFixed(2); entry.spencerOwes = +(val * 0.5).toFixed(2); }
        else if (splitType && splitType.indexOf('Custom') === 0) { entry.connorOwes = +(val * customConnorPct / 100).toFixed(2); entry.spencerOwes = +(val * customSpencerPct / 100).toFixed(2); }
        else if (splitType === 'Connor owes Spencer') { entry.connorOwes = val; entry.spencerOwes = 0; }
        else { entry.connorOwes = 0; entry.spencerOwes = val; }
        entries.push(entry);
      } else if (expenseType === 'mom-owed') {
        entries.push({ sheet: 'Mom', date: now, description: desc || 'Expense', amount: val, type: 'Owed to Mom' });
      } else if (expenseType === 'mom-owes') {
        entries.push({ sheet: 'Mom', date: now, description: desc || 'Expense', amount: val, type: 'Mom Owes Connor' });
      }

      fetch(scriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ entries: entries }) })
      .then(function() {
        var msgs = {
          'costco': 'Costco expense of ' + fmt(val) + ' logged to both sheets',
          'cdy': fmt(val) + ' CDY charge added (Connor, 80/20)',
          'boobills': fmt(val) + ' added to Boo Bills (Paid by ' + paidBy + ', ' + splitType + ')',
          'mom-owed': fmt(val) + ' Connor owes Mom logged',
          'mom-owes': fmt(val) + ' Mom owes Connor logged'
        };
        document.getElementById('success-msg').textContent = msgs[expenseType];
        var sl = document.getElementById('success-sheet-link');
        if (sheetUrl) { sl.href = sheetUrl; sl.style.display = 'flex'; } else { sl.style.display = 'none'; }
        cachedBalances = null; // invalidate cache
        showScreen('success');
      }).catch(function() {
        errorArea.innerHTML = '<p class="error-msg">Failed to submit. Check your Apps Script URL.</p>';
      }).finally(function() { btn.disabled = false; btn.textContent = 'Log Expense'; });
    }

    function saveSettings() {
      scriptUrl = document.getElementById('settings-script-url').value.trim();
      sheetUrl = document.getElementById('settings-sheet-url').value.trim();
      try { localStorage.setItem('boobills_script_url', scriptUrl); localStorage.setItem('boobills_sheet_url', sheetUrl); } catch(e) {}
      cachedBalances = null;
      showScreen('home');
    }

    function updateHomeWarning() {
      var el = document.getElementById('home-warning');
      el.innerHTML = scriptUrl ? '' : '<div class="warning-box"><span style="font-size:18px">⚙️</span><p>Tap the settings icon to connect your Google Sheet.</p></div>';
    }
    function updateHomeSheetLink() {
      var el = document.getElementById('home-sheet-link');
      el.innerHTML = sheetUrl ? '<a class="sheet-link" href="' + sheetUrl + '" target="_blank" rel="noopener noreferrer">View Google Sheet <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/></svg></a>' : '';
    }

    // ═══ SUMMARY SCREEN ═══
    function updateSummarySheetLink() {
      var el = document.getElementById('summary-sheet-link-area');
      el.innerHTML = sheetUrl ? '<a class="summary-sheet-link" href="' + sheetUrl + '" target="_blank" rel="noopener noreferrer"><svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/></svg> Open Google Sheet</a>' : '';
    }

    function fetchExpenses() {
      var container = document.getElementById('summary-expenses');
      if (!scriptUrl) { container.innerHTML = '<div class="summary-empty"><div class="empty-icon">⚙️</div><p>Set your Apps Script URL in settings to view expenses.</p></div>'; return; }
      container.innerHTML = '<div class="balance-loading">Loading expenses<span class="dots"></span></div>';

      var cbName = 'bbexp_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
      var timeout = setTimeout(function() {
        delete window[cbName];
        container.innerHTML = '<div class="summary-empty"><div class="empty-icon">⏱</div><p>Timed out loading expenses. Tap refresh to try again.</p></div>';
      }, 10000);

      window[cbName] = function(data) {
        clearTimeout(timeout);
        delete window[cbName];
        renderExpenses(container, data);
      };

      var s = document.createElement('script');
      s.src = scriptUrl + '?action=expenses&sheet=Boo+Bills&callback=' + cbName;
      s.onerror = function() { clearTimeout(timeout); delete window[cbName]; container.innerHTML = '<div class="summary-empty"><div class="empty-icon">⚠️</div><p>Failed to load expenses. Your Apps Script may need updating to support the expenses endpoint.</p></div>'; };
      document.head.appendChild(s);
      setTimeout(function() { try { document.head.removeChild(s); } catch(e) {} }, 12000);
    }

    function renderExpenses(container, data) {
      if (!data || !data.expenses || data.expenses.length === 0) {
        container.innerHTML = '<div class="summary-empty"><div class="empty-icon">📋</div><p>No expenses yet. Start logging to see them here!</p></div>';
        return;
      }
      var html = '<div class="expense-list">';
      var expenses = data.expenses;
      for (var i = 0; i < expenses.length; i++) {
        var e = expenses[i];
        var tagColor = 'tag-accent';
        if (e.splitType && e.splitType.indexOf('Connor owes') >= 0) tagColor = 'tag-green';
        else if (e.splitType && e.splitType.indexOf('Spencer owes') >= 0) tagColor = 'tag-purple';

        html += '<div class="expense-item">' +
          '<div>' +
            '<div class="ei-amount">' + fmt(e.amount || 0) + '</div>' +
          '</div>' +
          '<div class="ei-details">' +
            '<div class="ei-desc">' + escHtml(e.description || 'Expense') + '</div>' +
            '<div class="ei-meta">' + escHtml(e.date || '') + ' · Paid by ' + escHtml(e.paidBy || '?') + '</div>' +
          '</div>' +
          '<div class="ei-split-tag tag ' + tagColor + '">' + escHtml(e.splitType || '') + '</div>' +
        '</div>';
      }
      html += '</div>';
      container.innerHTML = html;
    }

    function refreshSummary() {
      cachedBalances = null;
      var balEl = document.getElementById('summary-balance');
      balEl.innerHTML = '<div class="balance-card"><div class="balance-loading">Loading balance<span class="dots"></span></div></div>';
      fetchBalances(function(data) { renderBooBalance(balEl, data); });
      fetchExpenses();
    }

    function escHtml(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    function fmt(n) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n); }

    init();
  </script>
</body>
</html>
